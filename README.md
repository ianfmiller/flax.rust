# cross.scale.transmission.dynamics
This file contains analyses for a paper (in preparation) about the effects of climate change on the cross-scale transmission dynamics of flax rust disease. <br /> <br />
The below text provides a summary of the analysis pipeline. To recreate results, source the following files in order: <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/prep.enviro.data.R">prep enviro data.R</a> <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/plant loc data set building.R">plant loc data set building.R</a> <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/plant growth data prep.R">plant growth data prep.R</a> <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/plant growth analysis.R">plant growth analysis.R</a> <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/plant height dataset building.R">plant height data set building.R</a>  <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/pustule area data prep.R">pustule area data prep.R</a> <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/pustule area analysis.R">pustule area analysis.R</a> <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/n pustules data prep.R">n pusutles data prep.R</a> <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/n pustules analysis.R">n pustules analysis.R</a> <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/plant data prep">plant data prep.R</a> <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/plant analysis.R">plant analysis.R</a> <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/spore deposition model fitting tilt.R">spore deposition model fitting tilt.R</a> <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/building foi dataset.R">building foi dataset.R</a> <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/foi analysis.R">foi analysis.R</a> <br />
<a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/simulate.epidemic.R">simulate.epidemic.R</a>
## Data collection
## Statistical methods
Unless otherwise noted, we use the following modeling approach to investigate the relationship between a response variable (e.g. observed plant height at time t+1) and predictor variables. These predictor variables include the previous observed state (e.g. plant height at time t) and weather metrics (e.g. mean temperature).
<br />
<br />
We use generalized additive models (implemented via the mgcv package) to model the response variable as the sum of smooth functions of predictors: *y ~ s(x<sub>1</sub>) + s(x<sub>2</sub>) + ... + s(x<sub>n</sub>)*. These smooths are capable of capturing non-linear relationships between the predictors and the response variable. We limit the number of knots in each smooth to four in order to prevent overfitting. We include interactions with elapsed time for all predictor variables (except total rainfall) to account for the variation in the elapsed time between observations, and a random effect for site to account for the nested structure of our data. To select the most parsimonious model, we begin by fitting a model with all possible predictors using penalized cubic regression splines with an additional shrinkage penalty. This approach functionally removes insignificant predictors from the model, facilitating predictor selection (see <a href="https://stat.ethz.ch/R-manual/R-devel/library/mgcv/html/gam.selection.html">mgcv documentation</a>). Next, we iteratively remove insignificant terms from the model until none remained. We never removed the random effect of site, as it was included to account for non-independence in our data rather than as an explanatory variable. 
## General data prep
### Weather data
Weather data collected from sensors at each of four sites is compiled and cleaned in <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/prep.enviro.data.R">prep enviro data.R</a>. 
### Plant locations and epidemiological data
We recorded the locations of each plant in each transect at the begininning of the field season. When we observed a newly diseased plant, we re-recorded its location. In order to understand spatial epidemiological patterns, we need to match newly diseased plants to the healthy plants surveyed at the beginning of the season. This is accomplished in <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/plant loc data set building.R">plant loc data set building.R</a>. This script generates two data sets. The first, <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/summarized data/corrected.locs.RDS">corrected.locs.RDS</a>, gives the identity location of all (healthy and diseased) plants in each transect. The second, <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/summarized data/corrected.epi.RDS">corrected.epi.RDS</a>, gives the identity, location, and date first observed diseased for all infected plants. When the newly diseased plant was previously tagged, we updated its coordinates in the epidemiological data set to match its coordinates in the plant location data set. When the newly diseased plant was not previously tagged (and therefore able to be definitively matched to a record in the initial transect survey) we matched its identity and changed its coordinates to that of the closest untagged and unmatched healthy plant in the plant location daataset. Note that this procedure was also performed for plants that were tagged after being observed diseased. When no untagged and unmatched plant was withing *0.5m* of the newly diseased plant we assumed that it was either unemerged or missed during the initial survey, and added a new record into the plant location dataset to reflect its presence.
## Within host scale
The analysis begins at the with in host scale. 
### Plant growth
First, we investigate the relationship between plant growth and weather conditions.
#### Data preperation
In <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/plant growth data prep.R">plant growth data prep.R</a> longitudinal height data of healthy and diseased focal plants is joined. This raw data is stored as <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/summarized data/plant.heights.RDS">plant.heights.RDS</a>. To make this data usable for analyses, we join data on change in plant height with mean weather metrics in a new data object <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/summarized data/delta.heights.RDS">delta.heights.RDS</a>. As a part of this data preparation, raw data on plant infection intensity is also compiled as <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/summarized data/plants.RDS">plants.RDS</a>
#### Model fitting
In <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/plant growth analysis.R">plant growth analysis.R</a> we fit and visualize a model of plant height<sub>t+1</sub> as a sum of smoothed functions of plant height<sub>t</sub> and weather metrics (interactions with time are included for all predictors), and proceeded with our standard model selection approach. This model is saved as <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/models/plant.growth.model.RDS">plant.growth.model.RDS</a>.
#### Plant height dataset building
In a subsequent analysis of the effects of spore deposition on the odds of infection, we wish to use plant height as a predictor variable. However, for the majority of plants within the transect, heights were not recorded after the initial population survey. We use the <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/models/plant.growth.model.RDS">plant.growth.model.RDS</a> to simulate missing height data from weather conditions and the closest recorded height measurment for each plant in <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/plant height dataset building.R">plant height data set building.R</a>. This script uses convenience functions in <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/predict plant height change funcs.R">predict plant height change funcs.R</a>. The resutling dataset of observed and fore/hindcasted plant heights is stored as <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/models/corrected.plant.heights.RDS">corrected.plant.heights.RDS</a>.
### Pustlule growth
Next, we begin our analysis of the effects of climate change on the within host spread of disease beginning that the scale of a single pustule. 
#### Data preperation
In <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/pustule area data prep.R">pustule area data prep.R</a> we calculate pustule areas from the minimum and maximum diameters measured from pictures taken in the field. This data, along with other metadata including the date and time at which the pictures were taken are saved as <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/summarized data/pustules.RDS">pustules.RDS</a>. To facilitate analyses, we reformat this data, joining data on change in pustule diameter with mean weather metrics. This new data object is saved as <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/summarized data/delta.pustules.RDS">delta.pustules.RDS</a>. 
#### Model fitting
In <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/pustule area analysis.R">pustule area analysis.R</a> we fit a model of *pustule area<sub>t+1</sub>* as a sum of smoothed functions of *pustule area<sub>t</sub>* and weather metrics (interactions with time are included for all predictors), and proceeded with our standard model selection approach. This model is saved as <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/models/pustule.model.RDS">pustules.model.RDS</a>. 
#### Model interpretation and visualization
In order to translate the fitted model into predictions about climate effects on pustule growth, we need to be able to make predictions from the model. This requires constructing a dummy data set for the starting pustule area and weather conditions that we wish to investigate. These dummy data sets are constructed using convenience functions in  <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/within host climate prediction functions">within host climate prediction functions</a>. Using these dummy datasets, we make predictions via bootstrap simulations of the fitted model. 
<br />
<br />
We take two approaches to visualize the effect of climate change on the growth of pustules of various size. In the first, we simulate pustule growth using the fitted model and real weather data from days corresponding to the 50th, 75th, and 90th quantiles of hottest days observed during the data collection period. In the second, we simulate pustule growth using the fitted model and weather data from a day corresponding to 50th quantile of hottest days observed during the data collection period with either 0, 1.8, or 3.7 degrees added to individual temperature observations. In each approach we simulate area change across a one day window. 
<br />
<br />
To predict how climate change will affect the growth trajectory of pustules, we use the fitted model and longitudinal weather data to simulate the growth of a pustule over time. We added either 0, 1.8 or 3.7 degrees to observed temperature readings to investigate the effects of climate change. We assumed a starting pustule area of .01cm<sup>2</sup>, and simulated trajectories for 100 pustules at each of the temperature scenarios. We replicated this procedure for forward simulation windows of one, two, and seven days. 
### Pustule establishment
We next consider the process of pustule establishment. The main metric we use to investigate this process is the change in the number of pustules present on a leaf.
#### Data preperation
In <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/n pustules data prep.R">n pusutles data prep.R</a> we clean raw pustule count data, and save it as <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/summarized data/n.pustules.RDS">n.pustules.RDS</a>. To facilitate analyses, we reformat this data, joining data on change in pustule number with mean weather metrics. The new data object is saved as <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/summarized data/delta.n.pustules.RDS">delta.n.pustules.RDS</a>. 
#### Model fitting
In <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/n pustule analysis.R">n pustules analysis.R</a> we fit a model of *N pustules<sub>t+1</sub>* as a sum of smoothed functions of *N pustules<sub>t</sub>* and weather metrics (interactions with time are included for all predictors), and proceeded with our standard model selection approach. This model is saved as <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/models/pustule.model.RDS">pustules.model.RDS</a>. 
#### Model interpretation and visualization
We visualize the effects of climate change on pustule establishment by simulating <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/models/pustule.model.RDS">pustules.model.RDS</a>, while again making use of convenience functions in   <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/within host climate prediction functions">within host climate prediction functions</a>. First, we simulated how climate change would affect pustule establishment for leaves with various numbers of pustules already present. We considered the same two sets of climate scenarios descrbied in the pustule area section. Next, we use the fitted model and longitudinal weather data to simulate the change in the number of pustules on one leaf over time using the same procedure outlined in the pustule area section We assumed that leaves started with one pustule. 
### Plant infection intensity change
The final within host scale we consider is the intensity of infection within an entire plant. We construct a metric to measure this intensity by multiplying the number of diseased stems by the average length of diseased tissue on a stem by the average number of pustules found on a leaf in the middle of the region of infected tissue. Note that this is not an estimate of the total number of pustules on a plant as it ignores pustules present on stems.
#### Data preperation
Raw data on plant infection intensity is summarized into <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/summarized data/plants.RDS">plants.RDS</a> in <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/plant growth data prep.R">plant growth data prep.R</a>. This data is reformated in  <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/plant data prep">plant data prep.R</a> so that infection intensities at time t+1 are paired with infection intensities at time t and summary weather metrics. This new data object is stored as <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/summarized data/delta.plants.RDS">delta.plants.RDS</a>.
#### Model fitting
In <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/plant analysis.R">plant analysis.R</a> we fit a model of infection intensity<sub>t+1</sub> as a sum of smoothed functions of infection intensity<sub>t</sub> and weather metrics (interactions with time are included for all predictors). We included 10 knots for the smoothed function of infection intensity<sub>t</sub> in order to account for the signifincant nonlinear relationship between this term and infection intensity<sub>t+1</sub>. Our model selection approach followed the standard procedure outlined above. This model is saved as <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/models/plants.model.RDS">plants.model.RDS</a>. 
#### Model interpretation and visualization
We visualize the effects of climate change on within plant infection intensity by simulating <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/models/pustule.model.RDS">plants.model.RDS</a>, while again making use of convenience functions in <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/within host climate prediction functions.R">within host climate prediction functions.R</a>. First, we simulated how climate change would affect the change in infection intnsity for plants with infections of varying intensity. We considered the same two sets of climate scenarios descrbied in the pustule area section. Next, we use the fitted model and longitudinal weather data to simulate the change in plant infection intensity over time using the same procedure outlined in the pustule area section. We assumed plants to begin with an infection intensity score of 10.
## Between host scale
Building upon our inferences at the within host scale, we next consider the effects of climate on between host transmission processes.
### Spore deposition
Our investigation of between host transmission processes begins with the process of spore dispersal from an infected plant. We fit a tilted gaussian plume model to data describing spore deposition on traps placed in the field, as well as the infection intensiy andheight of source plants, and wind speed and direction. We make four simplifying assumptions when fitting this model. First, we assume that the quantity of spores being dispersed away from an infected plant is proportional to the infection intensity of that plant. Second, we assume the source of spore deposition to be at *0.5 * plant height* above the coordinates of the source plant. Third, we assume a minimum standard deviation of *0.5 * plant height* for the distribution of spores in the *z* (vertical) plane. Fourth, we assume a standard deviation of *0.25 * plant height* for the distribution of spores in the *y* (horizontal) plane. The functions for spore deposition fitting are contained in <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/spore deposition functions tilt.R">spore deposition functions tilt.R</a>. The model is fit in <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/spore deposition model fitting tilt.R">spore deposition model fitting tilt.R</a>. The fitted model is visualized in <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/visualize.spore.kernel.R">visualize.spore.kernel.R</a>.
### Spore deposition and infection
After quantifying the elationship between plant infection intensity and spore deposition, we can now investigate the relationship between spore deposition and plant infection intensity.
#### Data preparation
We wish to model the odds that a plant becomes infected as a function of spore deposition. This requires data on change in infection status and spore deposition. This dataset is compiled in <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/building foi dataset.R">building foi dataset.R</a>. We made regular observations about infection status for each plant, but because we only placed spore traps around several infected plants, it is necessary to simulate the spore deposition each healthy plant experienced between observations of infection status. To simulate the spore deposition experienced by each healthy plants, we summed spore deposition (as predicted by the tilted gaussian plume model, plant infection intensity, plant height, and wind speed and direction data) from each diseased plant in the transect. We refer to summed spore deposition as the 'force of infection'. To predict spore deposition, we use plant heights from <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/summarized data/corrected.plant.heights.RDS">corrected.plant.heights.RDS</a>. We use the observed plant infection intensity from the source plants when this data exists. When this data does not exist, we fore/hindcast infection intensity from the closest measurment using <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/models/plants.model.RDS">plants.model.RDS</a> and convenience functions in <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/predict plant inf intens change funcs.R">predict plant inf intens change funcs.R</a>.
#### Model fitting
Using this data, we fit a genearlized mixed models of infection outcome (with 1 representing a healthy plant becoming infected and 0 representing a healthy plant remaining healthy) predicted by the force of infection and weather metrics with a random intercept effect of site to account for the nested structure of our data. Our process for selecting between these models differed from our standard procedure because they are genearalized linear mixed models rather than generalized additive models. We construct a set of all possible combinations of predictors in <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/foi model set creation.R">foi model set creation.R</a>, and fit the associated models in <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/foi analysis.R">foi analysis.R</a>. We compare between them using AIC, and save the 'best' model as <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/models/foi.model.RDS">foi.model.RDS</a>. 
### Epidemic simulation
In the final stage of our analysis, we use our synthesize our findings about the effects of weather conditions on within and between host transmission processes to simulate the effects of climate change on epidemiological dynamics. The simulation algorithm is contained in <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/simulate.epidemic.R">simulate.epidemic.R</a>.
<br />
<br />
For each site, we use the observed coordinates of plants (from <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/summarized data/corrected.locs.RDS">corrected.locs.RDS</a>) and their starting disease status (from <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/summarized data/corrected.epi.RDS">corrected.epi.RDS</a>) to initialize the model. Plant infection intensities for initially infected plants are either set to the observed value on the first day of the epidemic simulation (if available) or fore/hindcaseted from the closest measurment. Using these starting conditions, we proceed with the simulaiton. Each step of the simulation spans 1 day.
<br />
<br />
 First, for each healhty plant, we calculate the force of infection experienced over the simulation step using the tilted gaussian plume model, real wind speed and direction data, and the heights and infection intensities of all diseased plants. We simulate the odds of infection from the <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/models/foi.model.RDS">foi.model.RDS</a> model, using the calculated foi, the height of the target plant, and real weather data spanning the simulation step. We draw a random number between 0 and 1, and if this number is less than or equal to the predicted odds of infection the plant becomes infected. 
 <br />
  <br />
When a healthy plant becomes infected, it's infection intensity metric must be set. We fit an exponential distribution to the observed infection intensities of newly diseased plants, and used the coefficients of this model to parameterize the cumulative probability distribution of this function. For each newly infected plant, we drew a random number between 0 and 1, and used the value of the cumulative distribution function as the plants starting infection intensity.
 <br />
 <br />
 After simulating new infections, we next simulated the changes in each previously diseased plant's infection status using a bootstrap simulation of <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/models/plants.model.RDS">plants.model.RDS</a> implemented via a convenience function in  <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/predict plant inf intens change funcs.R">predict plant inf intens change funcs.R</a>, real weather data, and each plant's current height and infection intensity.
 <br />
 <br />
 Finally, we simulated the growth of all plants using a bootstrap simulation of <a href="https://github.com/ianfmiller/flax.rust/blob/main/cross.scale.transmission.dynamics/models/plant.growth.model.RDS">plant.growth.model.RDS</a>, real weather data, and each plant's current height.
 <br />
 <br />
 We iterated this procedure over time to simulate population level changes in prevalence over the course of an epidemic. We replicated this analysis with either 0, 1.8, or 3.7 degrees added to temperature data to infer the effects of climate change. 

# quant.vir.evolution

## infeciton intensity survival analysis--demog data only.R
### Uses only 1st observations from within a season as predictors
### predicting probability of death from disease metrics and size metrics
### conclusions:
% stems infected increases odds of death; increased height decreases odds of death. <br />
N stems infected increases odds of death; total N stems decreases odds of death.

## infeciton intensity survival analysis
### predict death using only 1st observations of plants within a season
part 1: disease metrics as predictors, including healhty plant data <br />
part 2: disease metrics and size metrics as predictors, including H+D plant data <br />
part 3: disease metrics and size metrics at 1st observation as predictors, incluuding H+D plant data
#### conclusions:
Infection slightly increases odds of death for larger plants

## survival analysis
### Uses only 1st observations from within a season as predictors
### predicting probability of death from disease status and size metrics
### conclusions:
N stems decreases odds of death; no significant effect of disease status

## categorical outcome analysis
### ordinal logistic regression to predict status (H,D,X) from disease/size metrics
### conclusions: more diseased, small size correlated with D, then X, but effects are just barely statistically insignificant

